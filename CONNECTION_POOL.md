# ProxySQL 连接池增强版

本文档介绍了带有增强连接池功能的ProxySQL版本，用于优化与Aurora MySQL的连接管理和性能。

## 连接池功能概述

ProxySQL的连接池功能可以显著提高数据库连接的效率和性能：

1. **连接复用**：减少频繁建立和断开连接的开销
2. **连接限制**：防止数据库服务器因连接过多而过载
3. **连接生命周期管理**：自动处理空闲连接和连接超时
4. **查询多路复用**：允许多个客户端查询共享同一个后端连接

## 增强版特点

与基本版相比，连接池增强版具有以下特点：

1. **可配置的连接池参数**：通过CloudFormation参数自定义连接池行为
2. **优化的连接复用**：启用查询多路复用，提高连接利用率
3. **连接生命周期管理**：自动清理长时间运行的连接和事务
4. **连接池监控**：定期收集连接池统计信息，便于性能调优
5. **自动化健康检查**：更频繁的后端服务器健康检查

## 部署方法

使用专用的部署脚本部署带连接池的ProxySQL：

```bash
# 首先替换脚本中的占位符
sed -i 's/{{YOUR_DB_PASSWORD}}/您的实际密码/g' deploy-proxysql-connection-pool.sh

# 然后执行部署
./deploy-proxysql-connection-pool.sh <S3存储桶名称> <堆栈名称> <AWS区域> <VPC ID> <子网ID> <密钥对名称> <Aurora集群端点> <Aurora读取端点>
```

### 高级配置选项

部署脚本支持以下连接池参数的自定义：

```bash
./deploy-proxysql-connection-pool.sh <必要参数...> [允许的CIDR] [数据库名称] [数据库用户名] [数据库密码] [实例类型] [最大连接数] [每用户最大连接数] [连接最大存活时间(ms)] [空闲连接百分比] [连接复用延迟(ms)] [最大事务时间(ms)] [最大查询时间(ms)]
```

## 连接池参数说明

| 参数 | 默认值 | 说明 |
|------|--------|------|
| MaxConnections | 2000 | ProxySQL允许的最大客户端连接数 |
| MaxConnectionsPerUser | 1000 | 每个用户允许的最大连接数 |
| ConnectionMaxAgeMs | 3600000 | 连接的最大生命周期(1小时) |
| FreeConnectionsPct | 10 | 保持空闲的连接百分比 |
| ConnectionDelayMultiplexMs | 60000 | 延迟多路复用的时间(1分钟) |
| MaxTransactionTime | 1800000 | 最大事务时间(30分钟) |
| MaxQueryTime | 300000 | 最大查询时间(5分钟) |

## 测试连接池性能

部署完成后，可以使用提供的测试脚本验证连接池性能：

```bash
./test-connection-pool.sh <ProxySQL公网IP> <SSH密钥路径>
```

测试脚本会模拟不同的并发连接场景，并报告以下指标：

1. 客户端连接数
2. 总查询数
3. 使用的实际后端连接数
4. 连接复用率
5. ProxySQL连接池统计信息

## 监控连接池

ProxySQL实例上配置了自动监控脚本，每5分钟收集一次连接池统计信息，保存在`/var/log/proxysql-pool-stats.log`文件中。

您也可以随时通过ProxySQL管理界面查看连接池状态：

```bash
mysql -u admin -padmin -h <ProxySQL公网IP> -P 6032 -e "SELECT * FROM stats.stats_mysql_connection_pool;"
```

## 连接池性能优化建议

1. **调整MaxConnections**：根据应用程序的并发连接需求设置
2. **优化FreeConnectionsPct**：高流量系统可能需要更高的空闲连接百分比
3. **调整ConnectionMaxAgeMs**：减少此值可以更频繁地刷新连接
4. **监控连接复用率**：理想情况下，复用率应大于1.0，表示连接被有效复用

## 故障排除

如果遇到连接池相关问题，可以检查以下几点：

1. **连接拒绝**：检查MaxConnections和MaxConnectionsPerUser设置
2. **连接延迟**：可能需要增加FreeConnectionsPct值
3. **连接不稳定**：检查监控参数和健康检查超时设置
4. **性能下降**：调整ConnectionDelayMultiplexMs和连接复用设置

## 与基本版的比较

| 功能 | 基本版 | 连接池增强版 |
|------|--------|------------|
| 读写分离 | ✓ | ✓ |
| 连接池 | 基本 | 增强 |
| 连接复用 | 有限 | 完全支持 |
| 参数可配置 | 有限 | 完全支持 |
| 连接监控 | 基本 | 详细 |
| 性能优化 | 一般 | 高 |

## 适用场景

连接池增强版特别适合以下场景：

1. **高并发应用**：需要处理大量并发连接
2. **微服务架构**：大量服务需要短暂而频繁的数据库连接
3. **动态负载**：流量波动较大的应用
4. **资源受限环境**：需要最大化数据库连接利用率
